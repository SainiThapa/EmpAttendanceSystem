{% extends 'attendance/base.html' %}
{% load static %}

{% block content %}
<!-- Internal CSS for attendance calendar -->
<style>
    /* Calendar table styling */
    .nepali-calendar {
        font-size: 0.9rem;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* Employee header styling */
    .employee-header {
        width: 150px;
        text-align: left;
        vertical-align: middle;
        background-color: #343a40;
        color: white;
    }

    /* Day headers styling */
    .day-header {
        width: 40px;
        text-align: center;
        font-weight: bold;
    }

    /* Today's header styling */
    .day-header.today-cell {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        font-weight: bold;
    }

    /* Employee cells styling */
    .employee-cell {
        text-align: left;
        vertical-align: middle;
        background-color: #f8f9fa;
    }

    /* Day cells base styling */
    .day-cell {
        text-align: center;
        vertical-align: middle;
        height: 50px;
        cursor: default;
        transition: background-color 0.3s ease;
    }

    /* Attendance status styling for Present */
    .day-cell.status-present {
        background-color: #d4edda !important;
        cursor: pointer;
        color: #155724;
        font-weight: bold;
    }

    .day-cell.status-present:hover {
        background-color: #c3e6cb !important;
    }

    /* NEW: On Leave styling - Red background */
    .day-cell.status-leave {
        background-color: #f8d7da !important;
        cursor: pointer;
        color: #721c24;
        font-weight: bold;
    }

    .day-cell.status-leave:hover {
        background-color: #f5c6cb !important;
    }

    /* Status label styling */
    .day-cell .status-label {
        font-size: 0.9rem;
        vertical-align: middle;
        font-weight: 600;
    }

    /* Attendance icons */
    .day-cell .fa-check-circle {
        font-size: 1.1rem;
        color: #28a745;
    }

    /* NEW: Leave icon */
    .day-cell .fa-calendar-times {
        font-size: 1.1rem;
        color: #dc3545;
    }

    /* Tooltip styling */
    .tooltip-inner {
        max-width: 300px;
        text-align: left;
        background-color: #343a40;
        padding: 10px;
    }

    .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: #343a40;
    }

    /* Legend styling */
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        margin-bottom: 10px;
    }

    .legend-box {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        margin-right: 8px;
        border-radius: 4px;
    }

    .legend-text {
        font-size: 0.95rem;
        font-weight: 500;
    }
</style>

<!-- Main container with Bootstrap styling -->
<div class="container my-5">
    <!-- Header with gradient text -->
    <h2 class="mb-4 fw-bold text-center" style="background: linear-gradient(90deg, #0d6efd, #6610f2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <i class="fas fa-calendar-check me-2"></i> Attendance Calendar - {{ current_month_name }} {{ current_year }}
    </h2>

    <!-- Month selection form -->
    <div class="mb-4">
        <form method="get" class="d-flex justify-content-center">
            <select name="month" class="form-select me-2" style="width: auto;">
                {% for month in available_months %}
                    <option value="{{ month.month }}" {% if month.month == selected_month and month.year == selected_year %}selected{% endif %}>
                        {{ month.month_name }} {{ month.year }}
                    </option>
                {% endfor %}
            </select>
            <input type="hidden" name="year" value="{{ selected_year }}">
            <button type="submit" class="btn btn-primary">View</button>
        </form>
    </div>

    <!-- Legend -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Legend</h6>
            <div class="d-flex flex-wrap">
                <div class="legend-item">
                    <div class="legend-box" style="background-color: #d4edda;"></div>
                    <span class="legend-text"><i class="fas fa-check-circle text-success me-1"></i>Present</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background-color: #f8d7da;"></div>
                    <span class="legend-text"><i class="fas fa-calendar-times text-danger me-1"></i>On Leave</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background-color: #ffffff; border: 2px solid #ddd;"></div>
                    <span class="legend-text">No Record</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Card for calendar -->
    <div class="card shadow-lg border-0">
        <div class="card-body p-4">
            <!-- Responsive table for calendar -->
            <div class="table-responsive">
                <table class="table table-bordered nepali-calendar">
                    <thead class="table-dark">
                        <tr>
                            <th class="employee-header">Employee</th>
                            {% for day in days_in_month %}
                                <th class="day-header {% if day == today_date.day and selected_month == today_date.month and selected_year == today_date.year %}today-cell{% endif %}">{{ day }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee_data in attendance_data %}
                            <tr>
                                <!-- Employee name -->
                                <td class="employee-cell fw-bold">{{ employee_data.employee.name }}</td>
                                <!-- Days of month -->
                                {% for day in employee_data.days %}
                                    {% if day.is_leave %}
                                        <!-- Display On Leave (Red) -->
                                        <td class="day-cell status-leave"
                                            data-bs-toggle="tooltip"
                                            data-bs-html="true"
                                            title="<strong>On Leave</strong><br>{{ day.details.0.leave_title }}<br><small>{{ day.details.0.leave_remarks }}</small>">
                                            <i class="fas fa-calendar-times"></i>
                                            <span class="status-label d-block">On Leave</span>
                                        </td>
                                    {% elif day.status == 'Present' %}
                                        <!-- Display Present (Green) -->
                                        <td class="day-cell status-present"
                                            data-bs-toggle="tooltip"
                                            data-bs-html="true"
                                            title="<strong>Present</strong><br>Check-in: {{ day.details.0.check_in }}<br>Check-out: {{ day.details.0.check_out }}<br>Hours: {{ day.details.0.hours_worked|floatformat:2 }}">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="status-label d-block">Present</span>
                                        </td>
                                    {% else %}
                                        <!-- Empty cell for no record -->
                                        <td class="day-cell"></td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ days_in_month|length|add:1 }}" class="text-center">No employee data available.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Load custom JS for tooltips -->
<script src="{% static 'attendance/js/birthday_calendar.js' %}"></script>
{% endblock %}